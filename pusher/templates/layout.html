<!DOCTYPE html>
<html>
  <head>
    
    {% if title %}
    <title>SpeakEasy - {{ title }}</title>
    {% else %}
    <title>SpeakEasy - Chat</title>
    {% endif %}
    <title></title>


    <script src="https://js.pusher.com/4.3/pusher.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jquery-form/form@4.2.2/dist/jquery.form.min.js"></script>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/layout_style.css') }}">
    
    {% block chat_room_imports %}{% endblock chat_room_imports %}

    <script>
     $(document).ready(function () {
      SID = null;
      curr_room = "Global";
      pusher = new Pusher('da7281b2ef6e49a7428b', { authEndpoint:'/authenticate',
                                                    cluster:'us2',forceTLS:true });
      pusher.connection.bind('connected', function() {
        SID = pusher.connection.socket_id;
        save_user(SID,'{{curr_usr}}',curr_room);
        load_chat('{{ curr_usr }}',curr_room);
      });
      function save_user(SID,username) {
        $.post('/save',{'SID':SID,'username':username});
      }
      function mk_room(room) {
        return 'presence-'+room;
      }
      function load_chat(user,room) {
        user_count = 0;
        document.getElementById('current_room').innerHTML = room;
        messages= document.getElementById('msg_list');
        if (messages.children.length >= 1) {
          while (messages.firstChild) {
            messages.removeChild(messages.firstChild);
          }
        }
        users= document.getElementById('user_list');
        if (users.children.length >= 1) {
          while (users.firstChild) {
            users.removeChild(users.firstChild);
          }
        }
        channel = pusher.subscribe(mk_room(room));
        channel.bind('pusher:subscription_succeeded',
                      function(members) {
                        user_count = members.count
                        document.getElementById('user_count').innerHTML= user_count;
                        members.each(function (member) {
                          user_list= document.getElementById('user_list');
                          user_tag= document.createElement('p');
                          user_tag.innerHTML= member.id;
                          user_tag.className= 'username';
                          user_list.appendChild(user_tag);
                          if (member.id == user)
                            user_tag.className= 'username_b';
                        });
                    });
        channel.bind('pusher:member_added',
                      function(member) {
                        ++user_count;
                        document.getElementById('user_count').innerHTML= user_count;
                        user_list= document.getElementById('user_list');
                        user_tag= document.createElement('p');
                        user_tag.innerHTML= member.id;
                        user_tag.className= 'username';
                        user_list.appendChild(user_tag);
                    });
        channel.bind('pusher:member_removed',
                      function(member) {
                        --user_count;
                        document.getElementById('user_count').innerHTML= user_count;
                        user_list= document.getElementById('user_list');
                        users= user_list.children;
                        for (i=0;i<users.length;++i) {
                          if (users[i].innerHTML == member.id)
                            user_list.removeChild(users[i]);
                        }
                      });
        channel.bind('message',
                      function(data) {
                        msg=  document.createElement('p');
                        msg.innerHTML= data.msg;
                        msg.className= "message_left";
                        msg_user=  document.createElement('p');
                        msg_user.innerHTML= '- '+data.username;
                        msg_user.className= "message_user";
                        hr= document.createElement('hr');
                        messages.appendChild(msg);
                        messages.appendChild(msg_user); 
                        messages.appendChild(hr);
                        if (user == data.username)
                          msg.className= "message_right";
                      });
        $.post('/get/messages/'+room,
                function (data) { 
                  for (i=data['data'].length-1;i>=0;--i) {
                    msg=  document.createElement('p');
                    msg.innerHTML= data['data'][i][3];
                    msg.className= "message_left";
                    msg_user=  document.createElement('p');
                    msg_user.innerHTML= '- '+data['data'][i][1];
                    msg_user.className= "message_user";
                    hr= document.createElement('hr');
                    messages.appendChild(msg);
                    messages.appendChild(msg_user);
                    messages.appendChild(hr);
                    if (user == data['data'][i][1])
                      msg.className= "message_right";
                  }
                }
              );          
      }
      $(".room_item").click( function () {
        pusher.unsubscribe(mk_room(curr_room));
        curr_room= this.innerHTML;
        load_chat('{{ curr_usr }}',curr_room);
      });
      $("#settings_btn").click( function () {
        window.location.href= "{{ url_for('settings',username="") }}"+"{{curr_usr}}";
      });
      $("#logout_btn").click( function () {
        window.location.href= "{{ url_for('logout') }}";
      });
      $("#global_btn").click( function () {
        pusher.unsubscribe(mk_room(curr_room));
        curr_room= 'Global';
        load_chat('{{ curr_usr }}','Global');
      });
      $("#menu_toggle").click( function () {
        if ($("#sidebar").width() == 250) {
          $("#sidebar").css({"width":"0px"});
          $("#main").css({"margin-left":"0px"});
        }
        if ($("#sidebar").width() == 0) {
          $("#sidebar").css({"width":"250px"});
          $("#main").css({"margin-left":"250px"});
        } 
      });
    });
  </script>

  </head>
  <body>
    
    <div id="navbar">
      <span id="current_user">{{ curr_usr }}</span>
      <button type="button" id="logout_btn">Logout</button>
      <button type="button" id="settings_btn">Settings</button>
      <button type="button" id="menu_toggle">Hide Rooms</button>
      <button type="button" id="global_btn">Global Chat</button>
    </div>
    
    <div id="sidebar">
      <p id="menu_header"> Rooms In Your Area </p>
      <p class="room_item">Test_Room_1</p>
      <p class="room_item">Test_Room_2</p>
      <p class="room_item">Test_Room_3</p>
    </div>
    
    <div id="main">
      {% block chat_room %}{% endblock chat_room %}
    </div>

  </body>
</html>